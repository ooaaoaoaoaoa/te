<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4æŠã‚¯ã‚¤ã‚ºBot (ã‚ªãƒ¼ãƒˆã‚»ãƒ¼ãƒ– & ç« å¯¾å¿œ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        :root { --primary-color: #4a90e2; --bg-color: #f5f7fa; --accent-color: #f39c12; }
        body { font-family: sans-serif; background-color: var(--bg-color); margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        #quiz-container { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); width: 90%; max-width: 600px; }
        .header { display: flex; justify-content: space-between; margin-bottom: 1rem; color: #666; font-size: 0.9rem; }
        .question-text { font-size: 1.1rem; font-weight: bold; margin-bottom: 1.5rem; line-height: 1.5; }
        .options-grid { display: grid; gap: 10px; }
        button { padding: 1rem; border-radius: 8px; cursor: pointer; font-weight: bold; border: none; transition: 0.2s; }
        .option-btn { background: white; border: 2px solid #ddd; text-align: left; font-size: 0.95rem; }
        .option-btn:hover:not(:disabled) { background-color: #f0f7ff; border-color: var(--primary-color); }
        .next-btn, .action-btn { background-color: var(--primary-color); color: white; width: 100%; margin-top: 1rem; }
        .resume-btn { background-color: var(--accent-color); color: white; width: 100%; margin-bottom: 1rem; }
        .feedback { margin-top: 1rem; padding: 1rem; border-radius: 8px; display: none; }
        .correct { background-color: #d4edda; color: #155724; }
        .wrong { background-color: #f8d7da; color: #721c24; }
        .hidden { display: none; }
        .menu-item { display: block; width: 100%; padding: 0.8rem; margin-bottom: 0.5rem; background: #fff; border: 1px solid #ddd; text-align: left; border-radius: 5px; text-decoration: none; color: #333; }
        .menu-item:hover { background: #f9f9f9; }
        .badge { font-size: 0.7rem; background: #eee; padding: 2px 6px; border-radius: 4px; margin-left: 8px; }
    </style>
</head>
<body>

<div id="quiz-container">
    <div id="setup-screen">
        <h2 id="setup-title">ã‚¯ã‚¤ã‚ºã‚’é¸æŠ</h2>
        <div id="resume-area" class="hidden">
            <p style="color: var(--accent-color); font-weight: bold;">å‰å›ã®ç¶šããŒã‚ã‚Šã¾ã™</p>
            <button class="resume-btn" id="resume-game-btn">ç¶šãã‹ã‚‰å†é–‹ã™ã‚‹</button>
            <hr>
        </div>
        <div id="status-msg">èª­ã¿è¾¼ã¿ä¸­...</div>
        <div id="menu-content"></div>
    </div>

    <div id="game-screen" class="hidden">
        <div class="header">
            <div><span id="chapter-label" style="font-weight:bold; margin-right:10px;"></span> <span id="progress"></span></div>
            <span id="score-display"></span>
        </div>
        <div class="question-text" id="question"></div>
        <div class="options-grid" id="options-container"></div>
        <div id="feedback-area" class="feedback">
            <b id="result-label"></b>
            <div id="explanation-text" style="margin-top:0.5rem; font-size:0.85rem; white-space: pre-wrap;"></div>
            <button class="next-btn" id="next-question-btn">æ¬¡ã¸</button>
        </div>
    </div>

    <div id="result-screen" class="hidden">
        <h2 style="text-align:center">çµæœç™ºè¡¨</h2>
        <p style="text-align:center; font-size: 2rem;"><span id="final-score">0</span> / <span id="total-questions">0</span></p>
        <button class="action-btn" id="retry-wrong-btn">é–“é•ãˆãŸå•é¡Œã®ã¿ãƒªãƒˆãƒ©ã‚¤</button>
        <button class="action-btn" id="restart-btn" style="background-color: #95a5a6;">æœ€åˆã‹ã‚‰è§£ãç›´ã™</button>
        <button class="action-btn" id="back-to-menu-btn" style="background-color: #7f8c8d;">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
    </div>
</div>

<script>
    const GITHUB_USER = 'ooaaoaoaoaoa'; 
    const GITHUB_REPO = 'te';
    const SAVE_KEY = 'quiz_bot_save_data';

    let allQuestions = [];      // ãã®ãƒ•ã‚¡ã‚¤ãƒ«å…¨å•
    let filteredQuestions = []; // ç« ãªã©ã§çµã‚Šè¾¼ã‚“ã å•é¡Œ
    let currentQuestions = [];  // ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ç”¨
    let currentIndex = 0;
    let score = 0;
    let wrongQuestions = [];
    let currentFileName = "";
    let currentChapter = "";

    const setupScreen = document.getElementById('setup-screen');
    const gameScreen = document.getElementById('game-screen');
    const resultScreen = document.getElementById('result-screen');
    const menuContent = document.getElementById('menu-content');
    const statusMsg = document.getElementById('status-msg');

    // 1. åˆæœŸåŒ–: ã‚»ãƒ¼ãƒ–ç¢ºèªã¨ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§å–å¾—
    async function init() {
        const savedData = localStorage.getItem(SAVE_KEY);
        if (savedData) {
            document.getElementById('resume-area').classList.remove('hidden');
        }

        const hash = window.location.hash.replace('#', '');
        try {
            const apiUrl = `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/`;
            const response = await fetch(apiUrl);
            const files = await response.json();
            const csvFiles = files.filter(f => f.name.toLowerCase().endsWith('.csv'));

            if (hash) {
                // ç‰¹å®šã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã€ãã®ä¸­ã®ç« ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
                const target = csvFiles.find(f => f.name.replace('.csv', '') === decodeURIComponent(hash));
                if (target) {
                    currentFileName = target.name;
                    await loadFileAndShowChapters(target.download_url);
                }
            } else {
                showFileMenu(csvFiles);
            }
        } catch (e) {
            statusMsg.innerText = "ã‚¨ãƒ©ãƒ¼: èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
        }
    }

    // 2. ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§è¡¨ç¤º
    function showFileMenu(files) {
        statusMsg.innerText = "è§£ããŸã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã‚“ã§ãã ã•ã„ï¼š";
        menuContent.innerHTML = '';
        files.forEach(f => {
            const name = f.name.replace('.csv', '');
            const a = document.createElement('a');
            a.href = `#${encodeURIComponent(name)}`;
            a.className = 'menu-item';
            a.innerText = `ğŸ“„ ${name}`;
            a.onclick = () => setTimeout(() => location.reload(), 10);
            menuContent.appendChild(a);
        });
    }

    // 3. ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã€ç« ã®é¸æŠè‚¢ã‚’è¡¨ç¤º
    async function loadFileAndShowChapters(url) {
        statusMsg.innerText = "ç« ã‚’ç¢ºèªä¸­...";
        const resp = await fetch(url);
        const text = await resp.text();
        const results = Papa.parse(text, { header: true, skipEmptyLines: true, dynamicTyping: true });
        
        allQuestions = results.data.map(row => ({
            question: row['å•é¡Œæ–‡'],
            options: [row['é¸æŠè‚¢1'], row['é¸æŠè‚¢2'], row['é¸æŠè‚¢3'], row['é¸æŠè‚¢4']],
            answer: parseInt(row['æ­£è§£']),
            explanation: row['è§£èª¬'],
            chapter: String(row['ç« '] || "ãã®ä»–")
        })).filter(q => q.question);

        const chapters = [...new Set(allQuestions.map(q => q.chapter))];
        
        document.getElementById('setup-title').innerText = "ç« ã‚’é¸æŠ";
        statusMsg.innerText = "";
        menuContent.innerHTML = '';

        // ã€Œã™ã¹ã¦è§£ãã€
        const allBtn = document.createElement('button');
        allBtn.className = 'menu-item';
        allBtn.innerHTML = `ğŸŒŸ <strong>å…¨ç« ã¾ã¨ã‚ã¦è§£ã</strong> <span class="badge">${allQuestions.length}å•</span>`;
        allBtn.onclick = () => startQuiz(allQuestions, "å…¨ç« ");
        menuContent.appendChild(allBtn);

        // ç« ã”ã¨ã®ãƒœã‚¿ãƒ³
        chapters.forEach(ch => {
            const count = allQuestions.filter(q => q.chapter === ch).length;
            const btn = document.createElement('button');
            btn.className = 'menu-item';
            btn.innerHTML = `ç¬¬ ${ch} ç«  <span class="badge">${count}å•</span>`;
            btn.onclick = () => startQuiz(allQuestions.filter(q => q.chapter === ch), `ç¬¬ ${ch} ç« `);
            menuContent.appendChild(btn);
        });
    }

    // 4. ã‚¯ã‚¤ã‚ºé–‹å§‹ï¼ˆæ–°è¦ï¼‰
    function startQuiz(qs, chapterName) {
        currentQuestions = [...qs];
        currentIndex = 0; score = 0; wrongQuestions = [];
        currentChapter = chapterName;
        
        setupScreen.classList.add('hidden');
        resultScreen.classList.add('hidden');
        gameScreen.classList.remove('hidden');
        showQuestion();
    }

    // 5. å•é¡Œè¡¨ç¤º
    function showQuestion() {
        saveProgress(); // æ¯å›ã‚»ãƒ¼ãƒ–
        const q = currentQuestions[currentIndex];
        document.getElementById('chapter-label').innerText = currentChapter;
        document.getElementById('progress').innerText = `${currentIndex + 1} / ${currentQuestions.length}`;
        document.getElementById('score-display').innerText = `ã‚¹ã‚³ã‚¢: ${score}`;
        document.getElementById('question').innerText = q.question;
        
        const container = document.getElementById('options-container');
        container.innerHTML = '';
        document.getElementById('feedback-area').style.display = 'none';

        q.options.forEach((opt, i) => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerText = opt;
            btn.onclick = () => {
                container.querySelectorAll('button').forEach(b => b.disabled = true);
                const isCorrect = (i + 1) === q.answer;
                if (isCorrect) {
                    score++;
                    document.getElementById('result-label').innerText = "â— æ­£è§£ï¼";
                    document.getElementById('feedback-area').className = "feedback correct";
                } else {
                    wrongQuestions.push(q);
                    document.getElementById('result-label').innerText = `Ã— ä¸æ­£è§£ (æ­£è§£: ${q.answer})`;
                    document.getElementById('feedback-area').className = "feedback wrong";
                }
                document.getElementById('explanation-text').innerText = q.explanation || "";
                document.getElementById('feedback-area').style.display = 'block';
            };
            container.appendChild(btn);
        });
    }

    // 6. æ¬¡ã¸
    document.getElementById('next-question-btn').onclick = () => {
        currentIndex++;
        if (currentIndex < currentQuestions.length) {
            showQuestion();
        } else {
            showResults();
        }
    };

    function showResults() {
        localStorage.removeItem(SAVE_KEY); // çµ‚ã‚ã£ãŸã‚‰ã‚»ãƒ¼ãƒ–æ¶ˆå»
        gameScreen.classList.add('hidden');
        resultScreen.classList.remove('hidden');
        document.getElementById('final-score').innerText = score;
        document.getElementById('total-questions').innerText = currentQuestions.length;
        document.getElementById('retry-wrong-btn').classList.toggle('hidden', !wrongQuestions.length);
    }

    // ã‚»ãƒ¼ãƒ–ãƒ»ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½
    function saveProgress() {
        const data = {
            fileName: currentFileName,
            chapter: currentChapter,
            questions: currentQuestions,
            currentIndex: currentIndex,
            score: score,
            wrongQuestions: wrongQuestions,
            urlHash: window.location.hash
        };
        localStorage.setItem(SAVE_KEY, JSON.stringify(data));
    }

    document.getElementById('resume-game-btn').onclick = () => {
        const data = JSON.parse(localStorage.getItem(SAVE_KEY));
        if (data) {
            // ç¾åœ¨ã®ãƒãƒƒã‚·ãƒ¥ã¨ä¿å­˜æ™‚ã®ãƒãƒƒã‚·ãƒ¥ãŒé•ã†å ´åˆã¯ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¦ãƒªãƒ­ãƒ¼ãƒ‰
            if (window.location.hash !== data.urlHash) {
                window.location.hash = data.urlHash;
                location.reload();
                return;
            }
            currentFileName = data.fileName;
            currentChapter = data.chapter;
            currentQuestions = data.questions;
            currentIndex = data.currentIndex;
            score = data.score;
            wrongQuestions = data.wrongQuestions;

            setupScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            showQuestion();
        }
    };

    // ãã®ä»–ãƒœã‚¿ãƒ³
    document.getElementById('restart-btn').onclick = () => startQuiz(currentQuestions, currentChapter);
    document.getElementById('retry-wrong-btn').onclick = () => startQuiz(wrongQuestions, "ãƒªãƒˆãƒ©ã‚¤");
    document.getElementById('back-to-menu-btn').onclick = () => {
        window.location.hash = "";
        location.reload();
    };

    init();
</script>
</body>
</html>
